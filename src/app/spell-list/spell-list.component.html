<app-main-header></app-main-header>

<div  class="page" fxLayout="row" fxLayoutAlign="center" [ngStyle]="{ 'pointer-events' : disabled ? 'none' : ''}">
  <div *ngIf="!loading" class="container">

    <div fxLayout="row" fxLayoutAlign="space-between">

      <div *ngIf="settings.dmMode || filterName === 'dmMode'">
        <div class="dialog-toggle">
          <mat-slide-toggle [(ngModel)]="settings.dmMode" (ngModelChange)="onDmModeChange()" color="primary">
          </mat-slide-toggle>
        </div>
      </div>      

      <div *ngIf="settings.characterMode && characterData.selectedCharacter != undefined">
        <button mat-button color="primary" [matMenuTriggerFor]="menu" style="font-size: large; white-space: nowrap">
          <mat-icon class="normal-button-icon" style="margin-right: 3px !important">menu</mat-icon> {{characterData.selectedCharacter.mode}}
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item *ngFor="let mode of getModeOptions()" (click)="onModeChanged(mode)">{{mode}}</button>
        </mat-menu>
      </div>

      <div fxLayout="row" fxLayoutAlign="end" style="width: 100%">

        <div *ngIf="settings.characterMode">
          <button color="primary" mat-button (click)="openCharacterDialog()" matTooltip="Character Management" matTooltipShowDelay="{{tooltipDelay}}"
            style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis"
            [style.max-width.px]="characterData.selectedCharacter != undefined ? screenWidth - 220 : screenWidth - 100">
            <mat-icon class="normal-button-icon">manage_accounts</mat-icon>
            <span>
              {{characterData.selectedCharacter != undefined ? characterData.selectedCharacter.name : '&lt;choose character&gt;'}}
            </span>            
          </button>
        </div>      
  
        <button mat-icon-button class="normal-icon-button" color="primary" (click)="openSettingsDialog()" matTooltip="Settings" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon>settings</mat-icon>
        </button>

      </div>      

    </div>

    <mat-expansion-panel hideToggle (opened)="advancedFiltersPanelOpen = true"
      (closed)="advancedFiltersPanelOpen = false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Filters
        </mat-panel-title>
        <mat-panel-description>
          Press to {{advancedFiltersPanelOpen ? 'hide' : 'show'}}
        </mat-panel-description>
      </mat-expansion-panel-header>


      <div fxLayout="row wrap" fxLayoutAlign="center center">
      <!-- <div fxLayout="row wrap" fxLayoutAlign="left" fxLayoutAlign.lt-sm="space-evenly center"> -->

        <div fxLayout="column" class="filter-select">
          <div>Spell Level</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersLevel"
              (ngModelChange)="addFilterMulti(optionsLevel, selectedFiltersLevel)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersLevel.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsLevel" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Class</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersClass"
              (ngModelChange)="addFilterMulti(optionsClass, selectedFiltersClass)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersClass.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsClass" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>        

        <div fxLayout="column" class="filter-select">
          <div>Category</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersTag"
              (ngModelChange)="addFilterMulti(optionsTag, selectedFiltersTag)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersTag.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsTag" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div *ngIf="!characterSelected()" fxLayout="column" class="filter-select">
          <div>Preset</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersPreset"
              (ngModelChange)="addFilterMulti(optionsPreset, selectedFiltersPreset)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersPreset.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsPreset" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Casting Time</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersCastingTime"
              (ngModelChange)="addFilterMulti(optionsCastingTime, selectedFiltersCastingTime)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersCastingTime.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsCastingTime" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Attack\Save</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersAttackSave"
              (ngModelChange)="addFilterMulti(optionsAttackSave, selectedFiltersAttackSave)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersAttackSave.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsAttackSave" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Ritual <img class="image" src={{images.spellRitual}}></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersRitual">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsRitual, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsRitual, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Concentration <img class="image" src={{images.spellConcentration}}></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersConcentration">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsConcentration, true)">Yes
              </mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsConcentration, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Primary Targets</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersAffectedTargets"
              (ngModelChange)="addFilterMulti(optionsAffectedTargets, selectedFiltersAffectedTargets)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersAffectedTargets.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsAffectedTargets" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Range</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersRange"
              (ngModelChange)="addFilterMulti(optionsRange, selectedFiltersRange)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersRange.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsRange" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Subclass</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSubclass"
              (ngModelChange)="addFilterMulti(optionsSubclass, selectedFiltersSubclass)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSubclass.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsSubclass" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Source</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSource"
              (ngModelChange)="addFilterMulti(optionsSource, selectedFiltersSource)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSource.length}} selected</span>
              </mat-select-trigger>
              <mat-optgroup *ngFor="let group of optionsSourceGroups" [label]="group.name">
                <mat-option *ngFor="let filter of group.filters" [value]="filter">
                  {{filter.displayTextList}}</mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>
        </div>

      </div>

      <div *ngIf="characterSelected()" class="medium-gap">
        <mat-divider></mat-divider>
      </div>

      <div *ngIf="characterSelected()" fxLayout="row wrap" fxLayoutAlign="center center">

        <div *ngIf="showFilterKnown()" fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Known<mat-icon class="filterIcon">bookmark</mat-icon></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersCategoryKnown">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsCategoryKnown, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsCategoryKnown, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>
  
        <div *ngIf="showFilterAlways()" fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Always known<mat-icon class="filterIcon">star</mat-icon></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersCategoryAlways">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsCategoryAlways, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsCategoryAlways, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>
  
        <div *ngIf="showFilterLimited()" fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Limited use<mat-icon class="filterIcon">repeat_one_on</mat-icon></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersCategoryLimited">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsCategoryLimited, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsCategoryLimited, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>
  
        <div *ngIf="showFilterRitualCast()" fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Ritual Caster<mat-icon class="filterIcon">menu_book</mat-icon></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersCategoryRitualCast">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsCategoryRitualCast, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsCategoryRitualCast, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>
  
        <div *ngIf="showFilterPrepared()" fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Prepared<mat-icon class="filterIcon">label</mat-icon></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersCategoryPrepared">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsCategoryPrepared, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsCategoryPrepared, false)">No</mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

      </div>

      <div *ngIf="screenSm" class="medium-gap">
        <mat-divider></mat-divider>
      </div>


      <div *ngIf="!screenSm" class="big-gap" fxLayout="row" fxLayoutAlign="center">
        <button mat-raised-button color="primary" style="vertical-align: center;"
          (click)="showAdvancedFilters = !showAdvancedFilters">
          <span *ngIf="showAdvancedFilters">Hide Advanced Filters</span>
          <span *ngIf="!showAdvancedFilters">Show Advanced Filters</span>
        </button>
      </div>

      <div *ngIf="showAdvancedFilters || screenSm" fxLayout="row wrap" fxLayoutAlign="center center">
      <!-- <div *ngIf="showAdvancedFilters || screenSm" fxLayout="row wrap" fxLayoutAlign="left"
        fxLayoutAlign.lt-sm="space-evenly center"> -->

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Updated</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersUpdated">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsUpdated, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsUpdated, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Spell School</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSchool"
              (ngModelChange)="addFilterMulti(optionsSchool, selectedFiltersSchool)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSchool.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsSchool" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Theme</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersTheme"
              (ngModelChange)="addFilterMulti(optionsTheme, selectedFiltersTheme)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersTheme.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsTheme" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div *ngIf="characterSelected()" fxLayout="column" class="filter-select">
          <div>Preset</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersPreset"
              (ngModelChange)="addFilterMulti(optionsPreset, selectedFiltersPreset)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersPreset.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsPreset" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Damage Type</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersDamageType"
              (ngModelChange)="addFilterMulti(optionsDamageType, selectedFiltersDamageType)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersDamageType.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsDamageType" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div> 

        <div fxLayout="column" class="filter-select">
          <div>Condition</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersCondition"
              (ngModelChange)="addFilterMulti(optionsCondition, selectedFiltersCondition)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersCondition.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsCondition" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Casting Ability</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersSpellMod">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsSpellMod, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsSpellMod, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Upcastable <img class="image" src={{images.spellArrow}}></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersUpcastable">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsUpcastable, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsUpcastable, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>              

        <div fxLayout="column" class="filter-select">
          <div>Number of Targets</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersNumberOfTargets"
              (ngModelChange)="addFilterMulti(optionsNumberOfTargets, selectedFiltersNumberOfTargets)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersNumberOfTargets.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsNumberOfTargets" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Only Caster</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersTargetCaster">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsTargetCaster, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsTargetCaster, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Verbal (V)</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersComponentV">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsComponentV, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsComponentV, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Somatic (S)</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersComponentS">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsComponentS, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsComponentS, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Material (M)</div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersComponentM">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsComponentM, true)">Yes</mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsComponentM, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Value <img class="image" src={{images.spellCoins}}></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersMaterialValue">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsMaterialValue, true)">Yes
              </mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsMaterialValue, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">M consumed <img class="image" src={{images.spellCoins}}></div>
          <div style="text-align: center;">
            <mat-button-toggle-group multiple="true" [(ngModel)]="selectedFiltersMaterialConsumed">
              <mat-button-toggle value="true" (click)="addFilterToggle(optionsMaterialConsumed, true)">Yes
              </mat-button-toggle>
              <mat-button-toggle value="false" (click)="addFilterToggle(optionsMaterialConsumed, false)">No
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Required Save</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSave"
              (ngModelChange)="addFilterMulti(optionsSave, selectedFiltersSave)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSave.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsSave" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Attack Type</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersAttackType"
              (ngModelChange)="addFilterMulti(optionsAttackType, selectedFiltersAttackType)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersAttackType.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsAttackType" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Duration</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersDuration"
              (ngModelChange)="addFilterMulti(optionsDuration, selectedFiltersDuration)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersDuration.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsDuration" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>        

        <div fxLayout="column" class="filter-select">
          <div>Single Class</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSingleClass"
              (ngModelChange)="addFilterMulti(optionsSingleClass, selectedFiltersSingleClass)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSingleClass.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsSingleClass" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Must-Class</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersMustClass"
              (ngModelChange)="addFilterMulti(optionsMustClass, selectedFiltersMustClass)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersMustClass.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsMustClass" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Not this Class</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersNotClass"
              (ngModelChange)="addFilterMulti(optionsNotClass, selectedFiltersNotClass)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersNotClass.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsNotClass" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Single Category</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersSingleTag"
              (ngModelChange)="addFilterMulti(optionsSingleTag, selectedFiltersSingleTag)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersSingleTag.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsSingleTag" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Must-Category</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersMustTag"
              (ngModelChange)="addFilterMulti(optionsMustTag, selectedFiltersMustTag)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersMustTag.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsMustTag" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div fxLayout="column" class="filter-select">
          <div>Not this Category</div>
          <mat-form-field appearance="fill">
            <mat-select [(ngModel)]="selectedFiltersNotTag"
              (ngModelChange)="addFilterMulti(optionsNotTag, selectedFiltersNotTag)" multiple="true">
              <mat-select-trigger>
                <span class="filter-selection-number">{{selectedFiltersNotTag.length}} selected</span>
              </mat-select-trigger>
              <mat-option *ngFor="let filter of optionsNotTag" [value]="filter">
                {{filter.displayTextList}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>        

        <!-- <div fxLayout="column" class="filter-button-select">
          <div style="text-align: center;">Tags</div>
          <div style="text-align: center;">
            <mat-slide-toggle [(ngModel)]="showTags" color="primary">
            </mat-slide-toggle>
          </div>
        </div>

        <div class="Block">
          <label id="lbl">Test </label>
          <input type='file' (change)="fileChanged($event)">    
        </div> -->

      </div>

    </mat-expansion-panel>


    <div class="big-top-gap" style="margin-bottom: -1rem;" *ngIf="filters.length > 0">

      <mat-chip-set>
        <mat-chip-option *ngFor="let filter of filters" [selectable]=false [removable]=true
          (removed)="onFilterRemoved(filter)" [matTooltip]="filter.tooltip">
          <span class="chip-text">{{filter.displayText}}</span>
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip-option>
      </mat-chip-set>

      <button mat-button color="primary" (click)="onAllFiltersRemoved()">Clear all Filters <mat-icon iconPositionEnd>filter_alt_off</mat-icon></button>

    </div>    
        

    <div fxLayout="row wrap" fxLayoutAlign="left center" class="big-top-gap" style="margin-bottom: 5px">

      <div fxLayout="row" fxLayoutAlign="left center" style="width: 225px; margin-right: 1rem;">

        <div>
          <mat-form-field appearance="outline" subscriptSizing="dynamic" style="width: 210px; font-size: larger; margin-left: 3px; letter-spacing: normal">
            <mat-label>
              <mat-icon>search</mat-icon>
              <!-- Filter by Name -->
            </mat-label>
            <input matInput name="name" [(ngModel)]="filterName" (keyup)="onChange()">
            <button mat-icon-button class="normal-icon-button" style="margin-right: 5px" *ngIf="filterName.length > 0" color="primary" matSuffix (click)="onNameFilterCleared()">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
        </div>          

      </div>

      <div *ngIf="settings.showRandomControls" fxLayout="row" style='padding-bottom: 10px;'>

        <div>
          <button mat-raised-button [matMenuTriggerFor]="menu">{{stringOfRandomSpells}}</button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onRandomNumberChanged(0)">0</button>
            <button mat-menu-item (click)="onRandomNumberChanged(1)">1</button>
            <button mat-menu-item (click)="onRandomNumberChanged(2)">2</button>
            <button mat-menu-item (click)="onRandomNumberChanged(3)">3</button>
            <button mat-menu-item (click)="onRandomNumberChanged(4)">4</button>
            <button mat-menu-item (click)="onRandomNumberChanged(5)">5</button>
            <button mat-menu-item (click)="onRandomNumberChanged(6)">6</button>
            <button mat-menu-item (click)="onRandomNumberChanged(7)">7</button>
            <button mat-menu-item (click)="onRandomNumberChanged(8)">8</button>
            <button mat-menu-item (click)="onRandomNumberChanged(9)">9</button>
            <button mat-menu-item (click)="onRandomNumberChanged(10)">10</button>
          </mat-menu>
        </div>

        <div *ngIf="numberOfRandomSpells > 0">
          <button color="primary" mat-button (click)="onRandomNumberChanged(numberOfRandomSpells)">
            <mat-icon class="normal-button-icon">autorenew</mat-icon>
          </button>
        </div>

      </div>

      <!-- <div *ngIf="!settings.characterMode || characterData.selectedCharacter === undefined" fxFlexAlign="end" style='margin-left: auto'>
        <div>{{spellsFiltered.length}}
          {{spellsFiltered.length === 1 ? 'spell' : 'spells'}}</div>
      </div> -->

    </div>

    <div class="big-top-gap"></div>

    <div *ngIf="settings.characterMode && characterData.selectedCharacter != undefined"> 
  
      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.AddRemove && filters.length > 0"> 

        <div fxLayout="row wrap" fxLayoutAlign="start">
          <div>
            <button color="primary" [disabled]="disableButtonAddFiltered()" mat-button (click)="onAddAll()" matTooltip="Add all filtered to known spells" matTooltipShowDelay="{{tooltipDelay}}">
              <mat-icon class="normal-button-icon">add_circle</mat-icon>
              <span>
                {{removedInsteadOfKnown ? "Restore all deleted" : "Add all to known"}}
              </span>
            </button>
          </div>
    
          <div>
            <button color="primary" [disabled]="disableButtonRemoveFiltered()" mat-button (click)="onRemoveAll()" matTooltip="Remove all filtered from known spells" matTooltipShowDelay="{{tooltipDelay}}">
              <mat-icon class="normal-button-icon">remove_circle</mat-icon>
              <span>
                {{removedInsteadOfKnown ? "Delete all" : "Remove all from known"}}
              </span>
            </button>
          </div>
        </div>      

        <div fxLayout="row" style="margin-top: -5px; margin-left: 20px">
          <div style="display:flex; align-items:center">
            {{removedInsteadOfKnown ? "switch to known:" : "switch to deleted:"}}
          </div>
          <button color="primary" mat-icon-button class="normal-icon-button" (click)="removedInsteadOfKnown = !removedInsteadOfKnown">
            <mat-icon *ngIf="removedInsteadOfKnown">bookmark</mat-icon>
            <mat-icon *ngIf="!removedInsteadOfKnown">delete</mat-icon>
          </button>          
        </div>

      </div>      

      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.Prep && characterData.selectedCharacter.usePreparedBlueprints">

        <div style="font-size: smaller; font-style: italic;">Templates: apply, add, manage</div>

        <div style="margin-top: 3px; margin-bottom: 3px" fxLayout="row wrap" fxLayoutAlign="start">
          
          <!-- <button mat-fab class="normal-icon-button" [matMenuTriggerFor]="setBlueprints" color="primary" matTooltip="Set Blueprint" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>label</mat-icon>
          </button>  
          <mat-menu #setBlueprints="matMenu">
            <button mat-menu-item *ngFor="let blueprint of characterData.selectedCharacter.preparedBlueprints" (click)="onSetPreparationBlueprint(blueprint)">{{blueprint.name}}</button>
          </mat-menu>         -->
    
          <button mat-fab class="normal-icon-button mat-fab-button-no-shadow" [disabled]="characterData.selectedCharacter.preparedBlueprints.length < 1" [matMenuTriggerFor]="addBlueprints" color="primary" matTooltip="Add from Template" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>new_label</mat-icon>
          </button>
          <mat-menu #addBlueprints="matMenu">
            <button mat-menu-item *ngFor="let blueprint of characterData.selectedCharacter.preparedBlueprints" (click)="onApplyPreparationBlueprint(blueprint)">
              <span>{{blueprint.name}} </span>
              <span style="font-style: italic; font-size: smaller;">{{blueprint.preparedSpells.length}} (+{{applyPreparationBlueprint(blueprint, true)}})</span>
            </button>
          </mat-menu>
    
          <button style="margin-left: 20px" mat-fab class="normal-icon-button mat-fab-button-no-shadow" [disabled]="getTotalPreparedNumber() < 1" color="primary" (click)="openBlueprintDialog(true)" matTooltip="Create Template" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>format_list_bulleted_add</mat-icon>
          </button>

          <button style="margin-left: 20px" mat-fab class="normal-icon-button mat-fab-button-no-shadow" color="primary" [disabled]="characterData.selectedCharacter.preparedBlueprints.length < 1" (click)="openBlueprintDialog(false)" matTooltip="Template Management" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>edit_note</mat-icon>
          </button>
        </div>     

      </div>  

      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.Session" fxLayout="row wrap" fxLayoutAlign="start"> 
  
        <div *ngIf="characterData.selectedCharacter.limitedSpells.length > 0">
          <button color="primary" mat-button (click)="onRefreshUsed()" matTooltip="Refresh used spells" matTooltipShowDelay="{{tooltipDelay}}">
            <span>
              Refresh
            </span>
            <mat-icon class="normal-button-icon">repeat_one</mat-icon>
            <span>
              ({{characterData.selectedCharacter.usedSpells.length}})
            </span>
          </button>
        </div>
  
      </div>

    </div>


    <div *ngIf="settings.characterMode && characterData.selectedCharacter != undefined && characterData.selectedCharacter.mode != ModeOption.Session"
          class="sticky topbar">

      <ng-template #IconExplanation>
        <div style="margin-left: auto">
          <button color="primary" mat-icon-button class="normal-icon-button" (click)="openInfoDialog()" matTooltip="Icon explanation" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>help</mat-icon>
          </button>
        </div>
      </ng-template>
  
      <ng-template #IconAlways>
        <button mat-button *ngIf="characterData.selectedCharacter.alwaysSpells.length > 0"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryAlways)"
        (click)="onTotalClick(SpellFilterType.CategoryAlways)"
        matTooltip="filter always known" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" color="primary">star</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryAlways, false)">{{characterData.selectedCharacter.alwaysSpells.length}}</span>
        </button>
      </ng-template>
  
      <ng-template #IconLimited>
        <button mat-button *ngIf="characterData.selectedCharacter.limitedSpells.length > 0"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryLimited)"
        (click)="onTotalClick(SpellFilterType.CategoryLimited)"
        matTooltip="filter limited use" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" color="primary">repeat_one_on</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryLimited, false)">{{characterData.selectedCharacter.limitedSpells.length}}</span>
        </button>
      </ng-template>
  
      <ng-template #IconRitual>
        <button mat-button *ngIf="characterData.selectedCharacter.ritualSpells.length > 0"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryRitualCast)"
        (click)="onTotalClick(SpellFilterType.CategoryRitualCast)"
        matTooltip="filter ritual casting" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" color="primary">menu_book</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryRitualCast, false)">{{characterData.selectedCharacter.ritualSpells.length}}</span>
        </button>
      </ng-template>

      <ng-template #IconRemoved>
        <button mat-button *ngIf="characterData.selectedCharacter.showRemoved && characterData.selectedCharacter.removedSpells.length > 0"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryRemoved)"
        (click)="onTotalClick(SpellFilterType.CategoryRemoved)"
        matTooltip="filter deleted" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" color="primary">delete</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryRemoved, false)">{{characterData.selectedCharacter.removedSpells.length}}</span>
        </button>
      </ng-template>

      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.Overview" fxLayout="row wrap" fxLayoutAlign="start"> 

        <button mat-button *ngIf="showTotalKnown()"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryKnown)"
        (click)="onTotalClick(SpellFilterType.CategoryKnown)"
        matTooltip="filter known" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : knownHasError() ? 'red' : ''}" color="primary">bookmark</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryKnown, knownHasError())">{{getTotalKnown()}}</span>
        </button>
        
        <ng-template [ngTemplateOutlet]="IconAlways"></ng-template>   
        <ng-template [ngTemplateOutlet]="IconLimited"></ng-template>   
        <ng-template [ngTemplateOutlet]="IconRitual"></ng-template>                 

        <button mat-button *ngIf="showTotalPrepared()"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryPrepared)"
        (click)="onTotalClick(SpellFilterType.CategoryPrepared)"
        matTooltip="filter prepared" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : preparedHasError() ? 'red' : ''}" color="primary">label</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryPrepared, preparedHasError())">{{getTotalPrepared()}}</span>
        </button>
  
        <ng-template [ngTemplateOutlet]="IconExplanation"></ng-template>   

      </div>

      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.AddRemove" fxLayout="row wrap" fxLayoutAlign="start">

        <button mat-button *ngIf="showTotalKnown()"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryKnown)"
        (click)="onTotalClick(SpellFilterType.CategoryKnown)"
        matTooltip="filter known" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : knownCantripsHaveError() ? 'red' : ''}" color="primary">bookmark</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryKnown, knownCantripsHaveError())">{{getCantripsKnown()}}</span>
        </button>

        <button mat-button *ngIf="showTotalKnown()"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryKnown)"
        (click)="onTotalClick(SpellFilterType.CategoryKnown)"
        matTooltip="filter known" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : knownSpellsHaveError() ? 'red' : ''}" color="primary">bookmark</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryKnown, knownSpellsHaveError())">{{getSpellsKnown()}}</span>
        </button>


        <div fxLayout="row" fxLayoutAlign="start">
          <ng-template [ngTemplateOutlet]="IconAlways"></ng-template>   
          <ng-template [ngTemplateOutlet]="IconLimited"></ng-template>   
          <ng-template [ngTemplateOutlet]="IconRitual"></ng-template> 
          <ng-template [ngTemplateOutlet]="IconRemoved"></ng-template> 
        </div>        

        <ng-template [ngTemplateOutlet]="IconExplanation"></ng-template>    

      </div>    

      <div *ngIf="characterData.selectedCharacter.mode === ModeOption.Prep" fxLayout="row wrap" fxLayoutAlign="start">

        <button mat-button *ngIf="characterData.selectedCharacter.preparedCantripCasting"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryPrepared)"
        (click)="onTotalClick(SpellFilterType.CategoryPrepared)"
        matTooltip="filter prepared" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : preparedCantripsHaveError() ? 'red' : ''}" color="primary">label</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryPrepared, preparedCantripsHaveError())">{{getCantripsPrepared()}}</span>
        </button>
      
        <button mat-button *ngIf="characterData.selectedCharacter.preparedCasting"
        class="total" [ngStyle]="totalStyle(SpellFilterType.CategoryPrepared)"
        (click)="onTotalClick(SpellFilterType.CategoryPrepared)"
        matTooltip="filter prepared" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon class="normal-button-icon" [ngStyle]="{'color' : preparedSpellsHaveError() ? 'red' : ''}" color="primary">label</mat-icon>
          <span [ngStyle]="totalStyleText(SpellFilterType.CategoryPrepared, preparedSpellsHaveError())">{{getSpellsPrepared()}}</span>
        </button>

        <button *ngIf="characterData.selectedCharacter.preparedCantripCasting || characterData.selectedCharacter.preparedCasting" mat-icon-button class="normal-icon-button" (click)="onUnprepareAll()" matTooltip="clear all prepared" matTooltipShowDelay="{{tooltipDelay}}">
          <mat-icon color="primary">backspace</mat-icon>
        </button>

        <ng-template [ngTemplateOutlet]="IconExplanation"></ng-template>   

      </div>      

    </div> 
    
    <div class="big-top-gap" *ngIf="spellsFiltered.length === 0" style="font-style: italic; text-align: center;">
      {{getEmptyListText()}}
    </div>

    <mat-accordion #expansionAccordion hideToggle="false" multi="false" class="border-without-increase" style="display: block; border-color: red; border-width: 2px; margin-top: 3px; margin-bottom: 5px;"
    [ngStyle]="{'border-style' : showRedBorder() ? 'solid' : ''}">

      <mat-expansion-panel #panel id="panel{{i}}" *ngFor="let spell of spellsToShow; let i = index"
        [expanded]="i === expandedPanelIndex" (opened)="onSpellExpansionPanelOpened(i)"
        (closed)="onSpellExpansionPanelClosed(i)"
        [disabled]="greyOutUsed(spell) || greyOutRemoved(spell)"
        [style.background]="highlightSpell(spell)">

        <!-- Template for icons next to the spell name -->
        <ng-template #NameIcons>
          <div fxLayout="row nowrap" style="width: content">
            <div *ngIf="spell.ritual && !onlyCastAsRitual(spell)" class="spell-expansion-icon" matTooltip="{{spell.ritualTooltip}}"
              matTooltipShowDelay="{{tooltipDelay}}">
            <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellRitual}}></span>
            <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellRitualGrey}}></span>
            </div>
            <div *ngIf="spell.concentration" class="spell-expansion-icon"
                matTooltip="{{spell.concentrationTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellConcentration}}></span>
              <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellConcentrationGrey}}></span>
            </div>
            <div *ngIf="spell.componentsValue || spell.componentsConsumed" class="spell-expansion-icon"
                matTooltip="{{spell.materialTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellCoins}}></span>
              <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellCoinsGrey}}></span>
            </div>    
          </div>         
        </ng-template>

        <!-- Template for character icons next to the spell name -->
        <ng-template #CharacterIcons>
          <div fxLayout="row nowrap" style="width: content">
            <!--known-->
            <div *ngIf="showNameIcon(spell, 'known')" matTooltip="known spell" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><mat-icon class="characterIcon" color="primary">bookmark</mat-icon></span>
              <span *ngIf="greyOutUsed(spell)"><mat-icon class="characterIcon" style="color: grey">bookmark</mat-icon></span>
            </div>
            <!--ritualCasting-->
            <div *ngIf="showNameIcon(spell, 'ritualCasting')" matTooltip="ritual cast" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><mat-icon class="characterIcon" color="primary">menu_book</mat-icon></span>
              <span *ngIf="greyOutUsed(spell)"><mat-icon class="characterIcon" style="color: grey">menu_book</mat-icon></span>
            </div>
            <!--limited-->
            <div *ngIf="showNameIcon(spell, 'limited')" matTooltip="limited usable" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><mat-icon class="characterIcon" color="primary">repeat_one_on</mat-icon></span>
              <span *ngIf="greyOutUsed(spell)"><mat-icon class="characterIcon" style="color: grey">repeat_one_on</mat-icon></span>
            </div>
            <!--always-->
            <div *ngIf="showNameIcon(spell, 'always')" matTooltip="always usable" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><mat-icon class="characterIcon" color="primary">star</mat-icon></span>
              <span *ngIf="greyOutUsed(spell)"><mat-icon class="characterIcon" style="color: grey">star</mat-icon></span>
            </div>
            <!--prepared-->
            <div *ngIf="showNameIcon(spell, 'prepared')" matTooltip="prepared for casting" matTooltipShowDelay="{{tooltipDelay}}">
              <span *ngIf="!greyOutUsed(spell)"><mat-icon class="characterIcon" color="primary">label</mat-icon></span>
              <span *ngIf="greyOutUsed(spell)"><mat-icon class="characterIcon" style="color: grey">label</mat-icon></span>
            </div>
          </div>
        </ng-template>

        <!-- Template for first column -->
        <ng-template #FirstColumn>
            <div fxLayout="column" style="width: 250px;">
              <div fxLayout="row" style="width: 250px; height: 20px;">
                <div *ngIf="onlyCastAsRitual(spell)">
                  <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellRitual}}></span>
                  <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellRitualGrey}}></span>
                </div>         
                <div class="spell-expansion-header spell-expansion-name" [ngStyle]="{'font-weight' : onlyCastAsRitual(spell) ? '100' : ''}">
                  {{spell.name}}
                </div>
                <div>
                  <ng-template [ngTemplateOutlet]="NameIcons"></ng-template>
                </div>
                <div>
                  <ng-template [ngTemplateOutlet]="CharacterIcons"></ng-template>
                </div>
              </div>              
              <div class="spell-expansion-header spell-expansion-extra">
                <div *ngIf="!showColumnLevel">
                  <span *ngIf="spell.upcastable" matTooltip="{{spell.upcastableTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
                    <img class="image" style="max-height: 9px;" src={{images.spellArrowGrey}}>
                  </span>{{spell.smallDisplay}}
                </div>
                <div *ngIf="showColumnLevel">
                  {{spell.school}} - {{spell.componentsDisplayList}}
                </div>
              </div>
            </div>            
        </ng-template>

        <!-- Template for spell range -->
        <ng-template #SpellRange>
          <span *ngIf="!spell.range.containsAsset">{{spell.range.displayTextComplete}}</span>
          <span *ngIf="spell.range.containsAsset">{{spell.range.displayTextPart1}}<img class="image" src={{spell.range.assetPath}} matTooltip="{{spell.range.assetTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">{{spell.range.displayTextPart2}}</span>
        </ng-template>  

        <mat-expansion-panel-header [style.background]="highlightSpell(spell)" [ngClass]="{'striked-through': spell.removed}">

          <div *ngIf="i != expandedPanelIndex" fxLayout="row" fxLayoutAlign="space-between" style="width: 100%;">          

            <!-- 1st row: name -->
            <!-- <div fxLayout="column" style="width: 0px;">

              <div fxLayout="row" [style.width.px]="expansionPanelWidth < 325 ? expansionPanelWidth - 75 : 250">
                <div class="spell-expansion-header spell-expansion-name"
                  [style.max-width.px]="expansionPanelWidth < 325 ? expansionPanelWidth - 100 : 225">
                  {{spell.name}}
                </div>
                <ng-template [ngTemplateOutlet]="NameIcons"></ng-template>
              </div>
              <div class="spell-expansion-header spell-expansion-extra"
                [style.width.px]="expansionPanelWidth < 325 ? expansionPanelWidth - 50 : 275">
                <div *ngIf="!screenSm">{{spell.smallDisplay}}</div>
                <div *ngIf="screenSm">
                  {{spell.school}} - {{spell.componentsDisplayList}}
                </div>
              </div>
              
            </div> -->

            <!-- 1st row: name -->
            <div>

              <ng-template [ngTemplateOutlet]="FirstColumn"></ng-template>              
              
            </div>

            <!-- 2nd row: level -->
            <div *ngIf="showColumnLevel" class="spell-expansion-properties" style="width: 75px;">
              {{spell.levelDisplay}}
              <span *ngIf="spell.upcastable" matTooltip="{{spell.upcastableTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
                <!-- <img class="image" style="max-height: 10px;" src={{images.spellArrow}}> -->
                <span *ngIf="!greyOutUsed(spell)"><img class="image" style="max-height: 10px;" src={{images.spellArrow}}></span>
                <span *ngIf="greyOutUsed(spell)"><img class="image" style="max-height: 10px;" src={{images.spellArrowGrey}}></span>
              </span>
            </div>

            <!-- 3rd row: casting time -->
            <div *ngIf="showColumnCastingTime" class="spell-expansion-properties" style="width: 120px;">
              <span *ngIf="!onlyCastAsRitual(spell)">
                {{spell.castingTimeDisplayList}}
              </span>
              <span *ngIf="onlyCastAsRitual(spell)">
                Only as 
              </span>
              <span *ngIf="spell.ritual" style="margin-left: 2px" matTooltip="{{spell.ritualTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
                <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellRitual}}></span>
                <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellRitualGrey}}></span>
              </span>
              <span *ngIf="spell.smiteSpell" class="spell-expansion-icon" matTooltip="{{spell.smiteSpellTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
                <span *ngIf="!greyOutUsed(spell)"><img class="image" src={{images.spellHammer}}></span>
                <span *ngIf="greyOutUsed(spell)"><img class="image" src={{images.spellHammerGrey}}></span>
              </span>
            </div>

            <!-- 4th row: range -->
            <div *ngIf="showColumnRange" class="spell-expansion-properties" style="width: 145px;">
              <ng-template [ngTemplateOutlet]="SpellRange"></ng-template>
            </div>

            <!-- 5th row: targets -->
            <ng-template #Targets>
              <span *ngFor="let target of spell.targetsDisplay; let firstElement = first; let lastElement = last">
                <span *ngIf="firstElement"><img class="image" src={{images.spellTarget}}></span>
                {{target.displayText}}
                <span *ngIf="target.upcastableAsset" matTooltip="{{spell.upcastableTooltip}}" matTooltipShowDelay="{{tooltipDelay}}">
                  <img class="image" style="max-height: 10px;" src={{images.spellArrow}}>
                </span>
                <span *ngIf="!lastElement">/ </span>
              </span>
            </ng-template> 
            
            <!-- show targets -->
            <div *ngIf="!settings.showDuration">
              <!-- if "cannot also target caster"-->
              <div *ngIf="showColumnFlex && !spell.aoeIgnoresCaster" class="spell-expansion-properties" style="width: 150px;">          
                <ng-template [ngTemplateOutlet]="Targets"></ng-template>
              </div>
              <!-- if "can also target caster"-->
              <div *ngIf="showColumnFlex && spell.aoeIgnoresCaster" class="spell-expansion-propertiesSpecial" fxLayout="column" style="width: 150px;">           
                <div class="spell-expansion-header">
                  <ng-template [ngTemplateOutlet]="Targets"></ng-template>
                </div>
                <div class="spell-expansion-extra">
                  (does not hit Caster)
                  <!-- (Caster is not hit) -->
                </div>  
              </div>  
            </div>
                 
            <!-- show duration -->
            <div *ngIf="settings.showDuration">
              <div *ngIf="showColumnFlex" class="spell-expansion-properties" style="width: 150px;">
                <span *ngIf="spell.concentration" matTooltip="{{spell.concentrationTooltip}}"
                  matTooltipShowDelay="{{tooltipDelay}}">
                  <img class="image" src={{images.spellConcentration}}>
                </span>
                {{spell.getDurationForList()}}
              </div>             
            </div>             
              
              
            <!-- Components -->
            <!-- {{spell.componentsDisplayList}}
            <span *ngIf="spell.componentsValue || spell.componentsConsumed" matTooltip="{{spell.materialTooltip}}"
              matTooltipShowDelay="{{tooltipDelay}}">
              <img class="image" src={{images.spellCoins}}>
            </span> -->

            <!-- last row: tags -->
            <div *ngIf="showColumnTags" class="spell-expansion-properties" style="width: 120px; margin-right: 15px; text-align: end;">
              <span *ngFor="let tag of spell.tags" class="dot" [style.color]="tag.fontColor" [style.background]="tag.colorCode" matTooltip="{{tag.name}}">{{tag.abbreviation}}</span>
            </div>

            <!-- <div *ngIf="screenXl" class="spell-expansion-properties" style="margin-left: 30px; width: 150px;">
              <span *ngIf="spell.concentration" matTooltip="{{spell.concentrationTooltip}}"
                matTooltipShowDelay="{{tooltipDelay}}">
                <img class="image" src={{images.spellConcentration}}>
              </span>
              {{spell.durationDisplayList}}
            </div> -->

          </div>


          <div *ngIf="i === expandedPanelIndex">
            <div class="spell-expansion-name">
              {{spell.name}}
            </div>
            <div class="spell-expansion-extra">
              {{spell.levelSchoolDisplay}}
            </div>
          </div>

          <!-- <div *ngIf="i != expandedPanelIndex" fxLayout="column" style="width: 10px">
            <div class="spell-expansion-header" style="font-size: larger;" fxLayout="row">
              <div style="width: 400px;">{{spell.name}}</div>
              <div style="font-size: medium;">{{spell.castingTime}}</div>
            </div>
            <div class="spell-expansion-header"
              style="font-size: small; font-style: italic; padding-left: 0.25rem; color:gray; ">
              {{spell.levelSchoolDisplay}}
            </div>
          </div>

          <div *ngIf="i === expandedPanelIndex">
            <div style="font-size: larger;">
              {{spell.name}}
            </div>
            <div style="font-size: small; font-style: italic; padding-left: 0.25rem; color:gray; ">
              {{spell.levelSchoolDisplay}}
            </div>
          </div> -->

        </mat-expansion-panel-header>

        <ng-template matExpansionPanelContent>
          <div>

            <div>
              <span class="spell-property-denotation">Casting time:</span>
              <span *ngIf="!onlyCastAsRitual(spell)" class="spell-property-description">
                {{spell.castingTime}}
                <span *ngIf="spell.ritual"><img class="image" style="margin-left: 2px;" src={{images.spellRitual}}></span>
              </span>
              <span *ngIf="onlyCastAsRitual(spell)" class="spell-property-description"><img class="image" src={{images.spellRitual}}>10 Minutes + {{spell.castingTime}}</span>
            </div>

            <div>
              <span class="spell-property-denotation">Range (Area):</span>
              <span class="spell-property-description">
                <ng-template [ngTemplateOutlet]="SpellRange"></ng-template>
              </span>
            </div>

            <div>
              <span class="spell-property-denotation">Components:</span>
              <span class="spell-property-description">{{settings.onlyValueMaterials && !spell.componentsConsumed && !spell.componentsValue ? spell.componentsDisplayList : spell.componentsDisplay}}</span>
            </div>

            <div>
              <span class="spell-property-denotation">Duration:</span>
              <span class="spell-property-description">{{spell.duration}}</span>
            </div>

            <div *ngIf="spell.castingAbility.toLowerCase() != 'unknown'">
              <span class="spell-property-denotation">Attack/Save:</span>
              <span class="spell-property-description">{{spell.attacksSavesDisplay}}</span>
            </div>

            <div>

              <!--shows known/prepared/always information-->
              <div *ngIf="settings.characterMode && characterData.selectedCharacter != undefined" fxLayout="row" fxLayoutAlign="end">
                
                <ng-template #icon let-show="show" let-iconFull="iconFull" let-iconEmpty="iconEmpty">
                  <span *ngIf="show"><mat-icon color="primary">{{iconFull}}</mat-icon></span>
                  <span *ngIf="!show"><mat-icon style="color: grey">{{iconEmpty}}</mat-icon></span>
                </ng-template>

                <!--used-->
                <div *ngIf="showIconUsed(spell)">
                  <button color="primary" mat-button (click)="onUsed(spell)"
                    matTooltip="set the spell to used, you can't use it until the next refresh" matTooltipShowDelay="{{tooltipDelay}}">
                    <mat-icon class="normal-button-icon">pause_circle_filled</mat-icon> spell used for the day
                  </button>
                </div>                            
                <!--known-->
                <div *ngIf="showIconKnown(spell)">
                  <button *ngIf="!disableIconKnownLists()" class="infobutton" mat-icon-button (click)="onKnown(spell)"
                    matTooltip="known spell" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.known, iconFull:'bookmark', iconEmpty: 'bookmark_border'}"></ng-template>  
                  </button>
                  <ng-template *ngIf="disableIconKnownLists()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.known, iconFull:'bookmark', iconEmpty: 'bookmark_border'}"></ng-template>  
                </div>
                <!--ritualCasting-->
                <div *ngIf="showIconRitual(spell)">
                  <button *ngIf="!disableIconKnownLists()" class="infobutton" mat-icon-button (click)="onRitual(spell)"
                    matTooltip="ritual cast" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.ritualCast, iconFull:'menu_book', iconEmpty: 'import_contacts'}"></ng-template>                  
                  </button>
                  <ng-template *ngIf="disableIconKnownLists()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.ritualCast, iconFull:'menu_book', iconEmpty: 'import_contacts'}"></ng-template>  
                </div>
                <!--limited-->
                <div *ngIf="showIconLimited(spell)">
                  <button *ngIf="!disableIconKnownLists()" class="infobutton" mat-icon-button (click)="onLimited(spell)"
                    matTooltip="limited usable" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.limited, iconFull:'repeat_one_on', iconEmpty: 'repeat_one'}"></ng-template> 
                  </button>
                  <ng-template *ngIf="disableIconKnownLists()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.limited, iconFull:'repeat_one_on', iconEmpty: 'repeat_one'}"></ng-template>  
                </div>
                <!--always-->
                <div *ngIf="showIconAlways(spell)">
                  <button *ngIf="!disableIconKnownLists()" class="infobutton" mat-icon-button (click)="onAlways(spell)"
                    matTooltip="always usable" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.always, iconFull:'star', iconEmpty: 'star_border'}"></ng-template> 
                  </button>
                  <ng-template *ngIf="disableIconKnownLists()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.always, iconFull:'star', iconEmpty: 'star_border'}"></ng-template>  
                </div>
                <!--prepared-->
                <div *ngIf="showIconPrepared(spell)">
                  <button *ngIf="!disableIconPrepared()" class="infobutton" mat-icon-button (click)="onPreparation(spell)"
                    matTooltip="prepared for casting" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.prepared, iconFull:'label', iconEmpty: 'label_outline'}"></ng-template> 
                  </button>
                  <ng-template *ngIf="disableIconPrepared()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.prepared, iconFull:'label', iconEmpty: 'label_outline'}"></ng-template>  
                </div> 
                <!--removed-->
                <div *ngIf="showIconRemoved(spell)">
                  <button *ngIf="!disableIconKnownLists()" class="infobutton" mat-icon-button (click)="onRemoved(spell)"
                    matTooltip="delete from spell options" matTooltipShowDelay="{{tooltipDelay}}">
                    <ng-template [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.removed, iconFull:'delete', iconEmpty: 'delete_outline'}"></ng-template> 
                  </button>
                  <ng-template *ngIf="disableIconKnownLists()" [ngTemplateOutlet]="icon" [ngTemplateOutletContext]="{show: spell.removed, iconFull:'delete', iconEmpty: 'delete_outline'}"></ng-template>  
                </div>

              </div>

              <div>
                <div *ngIf="!settings.characterMode || characterData.selectedCharacter === undefined 
                || !(showIconKnown(spell) || showIconAlways(spell) || showIconLimited(spell) || showIconRitual(spell) || showIconPrepared(spell) || showIconUsed(spell))"
                class="big-top-gap" ></div>
                <div [innerHTML]="spell.descriptionDisplay"></div>    
              </div>

            </div>

            <div>
              <div fxLayout="row wrap" fxLayoutAlign="space-between center">
                <div fxLayout="column" fxLayoutAlign="center start" style="height: 48px;">
                  <div class="source-style">&#8226; {{spell.source}} &#8226;</div>
                </div>
                <div fxLayout="row" fxLayoutAlign="end center" fxFlex="auto">
                  <div *ngIf="!sharable">
                    <button color="primary" mat-icon-button class="normal-icon-button" (click)="onCopySpellLink(spell)">
                      <mat-icon>link</mat-icon>
                    </button>
                  </div>
                  <div *ngIf="sharable">
                    <button color="primary" mat-icon-button class="normal-icon-button" (click)="onShareSpell(spell)">
                      <mat-icon>share</mat-icon>
                    </button>
                  </div>
                  <div *ngIf="spell.translatable">
                    <button color="primary" mat-icon-button class="normal-icon-button" (click)="onTranslation(spell)">
                      <mat-icon>translate</mat-icon>
                    </button>
                  </div> 
                </div>                             
              </div>
              <div>
                <mat-divider></mat-divider>
              </div>
            </div>

            <div class="big-top-gap">
              <span class="spell-property-denotation">Classes:</span>
              <mat-chip-set>
                <mat-chip *ngFor="let spellClass of spell.classes">
                  <span class="chip-text">{{spellClass.name}}</span>
                </mat-chip>
              </mat-chip-set>
              <!-- <span class="spell-property-denotation">Classes:</span>
              <span class="spell-property-description">{{spell.classesDisplay}}</span> -->
            </div>

            <div class="medium-top-gap" *ngIf="spell.subclasses.length">
              <div class="spell-property-denotation">Subclasses:</div>
              <mat-chip-set>
                <mat-chip *ngFor="let spellSubclass of spell.subclasses">
                  <span class="chip-text">{{spellSubclass.name}}</span>
                </mat-chip>
              </mat-chip-set>
              <!-- <span class="spell-property-denotation">Subclasses:</span> -->
              <!-- <span class="spell-property-description">{{spell.subclassesDisplay}}</span> -->
            </div>
                       

            <div class="big-top-gap" *ngIf="showTags && spell.tags.length">
              
              <div>
                <mat-divider></mat-divider>
              </div>

              <div class="medium-top-gap">
                <mat-chip-set>
                  <mat-chip *ngFor="let spellTag of spell.tags"
                    [style.background]="spellTag.colorCode" [matTooltip]="spellTag.description">
                    <span class="chip-text-big" [style.color]="spellTag.fontColor">{{spellTag.name}}</span>
                  </mat-chip>
                </mat-chip-set>
              </div>

            </div>   

            <div *ngIf="spell.asset" class="big-top-gap">
              <img src={{spell.assetPath}} style="max-width: 100%; margin-right: 1rem;"/>
            </div>
            <!-- <div *ngIf="spell.asset" >
              <div style="display: none;">
                <img src={{spell.assetPath}} (error)="spellAssetNotLoaded(i, spell.assetPath)"/>
              </div>
              <div *ngIf="i != assetNotLoadedIndex" class="big-top-gap">
                <img src={{spell.assetPath}} style="max-width: 100%; margin-right: 1rem;"/>
              </div>
            </div> -->
            

          </div>
        </ng-template>

      </mat-expansion-panel>

    </mat-accordion>

    <div [ngStyle]="{'min-height' : settings.showPrint ? '70px' : '30px'}"></div>

    <div fxLayout="row" fxLayoutAlign="end end" class="bottom">      
      <div class="spellCount">        
        {{spellsToShow.length}}/{{spellsFiltered.length}}
        <span style="font-size: small;">{{spellsFiltered.length === 1 ? 'spell' : 'spells'}}</span>
        <div *ngIf="settings.showPrint">
          <button color="primary" mat-icon-button class="normal-icon-button" (click)="onPrint()" matTooltip="Export to .csv for print" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>print</mat-icon>
          </button>
          <button color="primary" mat-icon-button class="normal-icon-button" (click)="onCopyToClipboard()" matTooltip="Copy spell names to clipboard" matTooltipShowDelay="{{tooltipDelay}}">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
      </div>
    </div>

  </div>
</div>